#!/usr/bin/env bash
set -euo pipefail

os="{{ .chezmoi.os }}"

if [[ "$os" == "linux" ]]; then
  sudo_cmd="sudo"
  if ! command -v sudo >/dev/null 2>&1; then
    sudo_cmd=""
  fi
  if [[ -z "$sudo_cmd" ]] && [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
    echo "sudo not found and not running as root; cannot install packages."
    exit 1
  fi

  if command -v apt-get >/dev/null 2>&1; then
    ${sudo_cmd} apt-get update -y
    ${sudo_cmd} apt-get install -y \
      git curl ca-certificates unzip tar \
      zsh jq ripgrep fzf tmux \
      build-essential pkg-config \
      libssl-dev libcurl4-openssl-dev libxml2-dev \
      xclip fd-find \
      zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev \
      libncursesw5-dev xz-utils tk-dev libxmlsec1-dev libffi-dev liblzma-dev

    # Neovim (latest stable from GitHub releases for AstroNvim v0.10+ requirement)
    if ! command -v nvim >/dev/null 2>&1 || [[ "$(nvim --version | head -1 | grep -oP 'v\K[0-9]+')" -lt 10 ]]; then
      curl -Lo /tmp/nvim.tar.gz https://github.com/neovim/neovim/releases/latest/download/nvim-linux-x86_64.tar.gz
      ${sudo_cmd} rm -rf /opt/nvim
      ${sudo_cmd} tar -C /opt -xzf /tmp/nvim.tar.gz
      ${sudo_cmd} ln -sf /opt/nvim-linux-x86_64/bin/nvim /usr/local/bin/nvim
      rm -f /tmp/nvim.tar.gz
    fi

    # AstroNvim optional dependencies (lazygit, gdu, bottom)
    # lazygit
    if ! command -v lazygit >/dev/null 2>&1; then
      LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
      curl -Lo /tmp/lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz"
      tar xf /tmp/lazygit.tar.gz -C /tmp lazygit
      ${sudo_cmd} install /tmp/lazygit /usr/local/bin
      rm -f /tmp/lazygit /tmp/lazygit.tar.gz
    fi

    # gdu (disk usage analyzer)
    if ! command -v gdu >/dev/null 2>&1; then
      curl -L https://github.com/dundee/gdu/releases/latest/download/gdu_linux_amd64.tgz | tar xz -C /tmp
      ${sudo_cmd} install /tmp/gdu_linux_amd64 /usr/local/bin/gdu
      rm -f /tmp/gdu_linux_amd64
    fi

    # bottom (process viewer)
    if ! command -v btm >/dev/null 2>&1; then
      curl -Lo /tmp/bottom.deb https://github.com/ClementTsang/bottom/releases/latest/download/bottom_amd64.deb
      ${sudo_cmd} dpkg -i /tmp/bottom.deb || ${sudo_cmd} apt-get install -f -y
      rm -f /tmp/bottom.deb
    fi

    # Docker (official apt repo)
    if ! command -v docker >/dev/null 2>&1; then
      ${sudo_cmd} install -m 0755 -d /etc/apt/keyrings
      ${sudo_cmd} curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
      ${sudo_cmd} chmod a+r /etc/apt/keyrings/docker.asc
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo \"$VERSION_CODENAME\") stable" \
        | ${sudo_cmd} tee /etc/apt/sources.list.d/docker.list >/dev/null
      ${sudo_cmd} apt-get update -y
      ${sudo_cmd} apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
    fi

    if command -v docker >/dev/null 2>&1; then
      ${sudo_cmd} groupadd docker >/dev/null 2>&1 || true
      if [[ -n "${SUDO_USER:-}" ]]; then
        ${sudo_cmd} usermod -aG docker "$SUDO_USER" || true
      else
        ${sudo_cmd} usermod -aG docker "$(id -un)" || true
      fi
    fi

    # GitHub CLI
    if ! command -v gh >/dev/null 2>&1; then
      ${sudo_cmd} install -m 0755 -d /etc/apt/keyrings
      ${sudo_cmd} curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg -o /etc/apt/keyrings/githubcli-archive-keyring.gpg
      ${sudo_cmd} chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
        | ${sudo_cmd} tee /etc/apt/sources.list.d/github-cli.list >/dev/null
      ${sudo_cmd} apt-get update -y
      ${sudo_cmd} apt-get install -y gh
    fi

    # pyenv
    if [[ ! -d "${HOME}/.pyenv" ]]; then
      curl https://pyenv.run | bash
    fi
  else
    echo "No apt-get found; linux package install not implemented for this distro."
  fi

  # LastPass CLI: try apt, then build from source as fallback.
  if ! command -v lpass >/dev/null 2>&1; then
    ${sudo_cmd} apt-get install -y lastpass-cli || true
  fi
  if ! command -v lpass >/dev/null 2>&1; then
    tmp="$(mktemp -d)"
    git clone --depth=1 https://github.com/lastpass/lastpass-cli.git "$tmp/lastpass-cli"
    (cd "$tmp/lastpass-cli" && make && ${sudo_cmd} make install)
    rm -rf "$tmp"
  fi

  # Try to log in so secrets can be templated during init.
  if command -v lpass >/dev/null 2>&1; then
    if ! lpass status >/dev/null 2>&1; then
      if [[ -n "{{ .lastpassLoginEmail }}" ]]; then
        lpass login --trust "{{ .lastpassLoginEmail }}" || true
      fi
    fi
  fi

elif [[ "$os" == "darwin" ]]; then
  # Homebrew
  if ! command -v brew >/dev/null 2>&1; then
    echo "Homebrew not found. Install it first (https://brew.sh) then re-run chezmoi apply."
    exit 0
  fi

  brew update
  brew install \
    git zsh jq ripgrep fzf fd \
    lastpass-cli gh pyenv \
    neovim lazygit gdu bottom
else
  echo "Unsupported OS: $os"
fi

# GitHub CLI Setup
if command -v gh >/dev/null 2>&1; then
  if ! gh auth status >/dev/null 2>&1; then
    echo "GitHub CLI is installed but not logged in."
    # Check if running interactively
    if [ -t 0 ]; then
      read -p "Login to GitHub CLI now? [y/N] " -n 1 -r
      echo
      if [[ $REPLY =~ ^[Yy]$ ]]; then
        gh auth login
        gh auth setup-git
      fi
    else
      echo "Non-interactive session, skipping gh login."
    fi
  fi
fi
