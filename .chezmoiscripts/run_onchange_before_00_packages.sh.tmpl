#!/usr/bin/env bash
set -euo pipefail

os="{{ .chezmoi.os }}"

if [[ "$os" == "linux" ]]; then
  sudo_cmd="sudo"
  if ! command -v sudo >/dev/null 2>&1; then
    sudo_cmd=""
  fi
  if [[ -z "$sudo_cmd" ]] && [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
    echo "sudo not found and not running as root; cannot install packages."
    exit 1
  fi

  if command -v apt-get >/dev/null 2>&1; then
    ${sudo_cmd} apt-get update -y
    ${sudo_cmd} apt-get install -y \
      git curl ca-certificates unzip tar \
      zsh jq ripgrep fzf \
      build-essential pkg-config \
      libssl-dev libcurl4-openssl-dev libxml2-dev

    # Docker (official apt repo)
    if ! command -v docker >/dev/null 2>&1; then
      ${sudo_cmd} install -m 0755 -d /etc/apt/keyrings
      ${sudo_cmd} curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
      ${sudo_cmd} chmod a+r /etc/apt/keyrings/docker.asc
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo \"$VERSION_CODENAME\") stable" \
        | ${sudo_cmd} tee /etc/apt/sources.list.d/docker.list >/dev/null
      ${sudo_cmd} apt-get update -y
      ${sudo_cmd} apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
    fi

    if command -v docker >/dev/null 2>&1; then
      ${sudo_cmd} groupadd docker >/dev/null 2>&1 || true
      if [[ -n "${SUDO_USER:-}" ]]; then
        ${sudo_cmd} usermod -aG docker "$SUDO_USER" || true
      else
        ${sudo_cmd} usermod -aG docker "$(id -un)" || true
      fi
    fi
  else
    echo "No apt-get found; linux package install not implemented for this distro."
  fi

  # LastPass CLI: try apt, then build from source as fallback.
  if ! command -v lpass >/dev/null 2>&1; then
    ${sudo_cmd} apt-get install -y lastpass-cli || true
  fi
  if ! command -v lpass >/dev/null 2>&1; then
    tmp="$(mktemp -d)"
    git clone --depth=1 https://github.com/lastpass/lastpass-cli.git "$tmp/lastpass-cli"
    (cd "$tmp/lastpass-cli" && make && ${sudo_cmd} make install)
    rm -rf "$tmp"
  fi

  # Try to log in so secrets can be templated during init.
  if command -v lpass >/dev/null 2>&1; then
    if ! lpass status >/dev/null 2>&1; then
      if [[ -n "{{ .lastpassLoginEmail }}" ]]; then
        lpass login --trust "{{ .lastpassLoginEmail }}" || true
      fi
    fi
  fi

elif [[ "$os" == "darwin" ]]; then
  # Homebrew
  if ! command -v brew >/dev/null 2>&1; then
    echo "Homebrew not found. Install it first (https://brew.sh) then re-run chezmoi apply."
    exit 0
  fi

  brew update
  brew install \
    git zsh jq ripgrep fzf \
    lastpass-cli
else
  echo "Unsupported OS: $os"
fi
